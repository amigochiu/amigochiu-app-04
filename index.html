<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LINE 貼圖產生器</title>

    <!-- PWA Meta Tags -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#06C755">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="./icon-192.png">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        line: {
                            DEFAULT: '#06C755',
                            dark: '#05B34C',
                            light: '#E3F9E5'
                        }
                    }
                }
            }
        }
    </script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- JSZip -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <style>
        /* Custom Styles */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        .checkerboard {
            background-image:
                linear-gradient(45deg, #ccc 25%, transparent 25%),
                linear-gradient(-45deg, #ccc 25%, transparent 25%),
                linear-gradient(45deg, transparent 75%, #ccc 75%),
                linear-gradient(-45deg, transparent 75%, #ccc 75%);
            background-size: 16px 16px;
            background-position: 0 0, 0 8px, 8px -8px, -8px 0px;
        }

        /* Hide scrollbar for clean UI */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>

<body class="bg-[#F0F5F0] text-gray-800 pb-20 min-h-screen relative">

    <!-- API Key Modal (Initially Hidden) -->
    <div id="api-key-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-md p-6 space-y-4">
            <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                <i data-lucide="key" class="text-line"></i> 設定 API Key
            </h3>
            <p class="text-gray-600 text-sm">請輸入您的 Google Gemini API Key 以開始使用。Key 將僅儲存於您的瀏覽器中。</p>
            <input type="password" id="api-key-input"
                class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-line outline-none"
                placeholder="Paste your API Key here...">
            <div class="flex justify-end gap-2">
                <button id="test-api-key-btn"
                    class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-medium transition-colors">
                    測試 Key
                </button>
                <button id="save-api-key-btn"
                    class="px-4 py-2 bg-line text-white rounded-lg font-medium hover:bg-line-dark transition-colors">儲存</button>
            </div>
            <p class="text-xs text-center text-gray-400 mt-2"><a href="https://aistudio.google.com/app/apikey"
                    target="_blank" class="underline hover:text-line">點此獲取免費用 Gemini API Key</a></p>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-line border-b border-line-dark sticky top-0 z-40 shadow-md safe-area-top">
        <div class="max-w-4xl mx-auto px-4 py-3 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-white rounded-lg flex items-center justify-center text-line font-bold shadow-sm">
                    <i data-lucide="image" size="20"></i>
                </div>
                <div class="flex items-baseline gap-2">
                    <h1 class="text-lg font-bold text-white tracking-tight">LINE 貼圖產生器</h1>
                    <span class="text-[10px] text-green-100/80 font-mono">v2026.01.20.010</span>
                </div>
            </div>

            <button id="settings-btn" class="text-white p-2 hover:bg-white/10 rounded-full transition-colors relative">
                <i data-lucide="settings" size="20"></i>
            </button>
        </div>
    </header>

    <main class="max-w-4xl mx-auto px-4 py-6 space-y-6">

        <!-- 0. API Key Alert (Shown if missing) -->
        <div id="api-key-alert"
            class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg flex items-center justify-between shadow-sm">
            <div class="flex items-center gap-2">
                <i data-lucide="alert-circle" size="18"></i>
                <span class="text-sm font-medium">尚未設定 API Key</span>
            </div>
            <button id="alert-settings-btn"
                class="text-xs bg-red-100 hover:bg-red-200 px-3 py-1 rounded text-red-800 transition-colors">設定</button>
        </div>

        <!-- 1. Upload Section -->
        <section class="bg-white rounded-xl p-5 shadow-sm border border-gray-100">
            <h2 class="text-lg font-semibold mb-4 flex items-center gap-2 text-gray-800">
                <span
                    class="w-6 h-6 rounded-full bg-line-light text-line-dark flex items-center justify-center text-xs font-bold shadow-sm">1</span>
                上傳圖片
            </h2>

            <!-- Upload Area -->
            <div id="upload-area"
                class="border-2 border-dashed border-gray-200 rounded-xl p-8 text-center hover:border-line transition-colors bg-gray-50 cursor-pointer">
                <input type="file" id="file-input" accept="image/png, image/jpeg, image/webp" class="hidden">
                <div class="flex flex-col items-center gap-3">
                    <div class="w-16 h-16 bg-white text-line rounded-full flex items-center justify-center shadow-sm">
                        <i data-lucide="upload" size="32"></i>
                    </div>
                    <div class="space-y-1">
                        <p class="font-medium text-gray-700">點擊上傳角色圖片</p>
                        <p class="text-sm text-gray-500">僅限一張 (JPG, PNG, WEBP)</p>
                    </div>
                </div>
            </div>

            <!-- Preview Area (Hidden by default) -->
            <div id="preview-area" class="hidden flex flex-col items-center gap-4 py-4">
                <div class="relative group">
                    <img id="source-preview" src="" alt="Source"
                        class="w-48 h-48 object-contain border-4 border-gray-50 rounded-lg shadow-md bg-gray-50">
                </div>
                <button id="remove-image-btn"
                    class="flex items-center gap-2 text-red-500 hover:text-red-600 text-sm px-4 py-2 hover:bg-red-50 rounded-md transition-colors border border-red-100 shadow-sm">
                    <i data-lucide="trash-2" size="16"></i>
                    刪除圖片
                </button>
            </div>
        </section>

        <!-- 2. Expressions Section -->
        <section class="bg-white rounded-xl p-5 shadow-sm border border-gray-100">
            <h2 class="text-lg font-semibold mb-4 flex items-center gap-2 text-gray-800">
                <span
                    class="w-6 h-6 rounded-full bg-line-light text-line-dark flex items-center justify-center text-xs font-bold shadow-sm">2</span>
                選擇表情
            </h2>

            <div id="expressions-grid" class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-6">
                <!-- Expression items will be injected here by JS -->
            </div>

            <div class="flex gap-2">
                <input type="text" id="custom-expression-input" placeholder="輸入自訂表情 (例如: 崩潰大哭)"
                    class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-line outline-none bg-gray-50 shadow-sm transition-all text-sm">
                <button id="add-expression-btn"
                    class="px-4 py-2 bg-gray-800 text-white font-medium rounded-lg hover:bg-gray-900 disabled:opacity-50 flex items-center gap-2 shadow-sm transition-all text-sm shrink-0">
                    <i data-lucide="plus" size="16"></i> 加入
                </button>
            </div>
        </section>

        <!-- 3. Styles Section -->
        <section class="bg-white rounded-xl p-5 shadow-sm border border-gray-100">
            <h2 class="text-lg font-semibold mb-4 flex items-center gap-2 text-gray-800">
                <span
                    class="w-6 h-6 rounded-full bg-line-light text-line-dark flex items-center justify-center text-xs font-bold shadow-sm">3</span>
                風格設定
            </h2>

            <div class="space-y-4">
                <!-- Style Options -->
                <div class="flex flex-col sm:flex-row gap-3">
                    <div class="style-option flex-1 flex items-center gap-3 p-3 rounded-lg border cursor-pointer select-none transition-all active"
                        data-id="cute_anime">
                        <div
                            class="checkbox w-5 h-5 rounded border flex items-center justify-center transition-colors bg-line border-line">
                            <i data-lucide="check" size="14" class="text-white"></i>
                        </div>
                        <span class="text-sm font-medium">可愛動漫風</span>
                    </div>
                    <div class="style-option flex-1 flex items-center gap-3 p-3 rounded-lg border cursor-pointer select-none transition-all active"
                        data-id="handwritten_text">
                        <div
                            class="checkbox w-5 h-5 rounded border flex items-center justify-center transition-colors bg-line border-line">
                            <i data-lucide="check" size="14" class="text-white"></i>
                        </div>
                        <span class="text-sm font-medium">加上趣味文字</span>
                    </div>
                </div>

                <!-- Age Options -->
                <div class="grid grid-cols-2 gap-3">
                    <!-- Injected by JS or static -->
                    <div class="age-option flex items-center gap-2 p-3 rounded-lg border cursor-pointer select-none transition-all active"
                        data-id="original">
                        <div
                            class="radio w-4 h-4 rounded-full border flex items-center justify-center transition-colors border-line">
                            <div class="w-2 h-2 rounded-full bg-line"></div>
                        </div>
                        <span class="text-sm">保持原樣</span>
                    </div>
                    <div class="age-option flex items-center gap-2 p-3 rounded-lg border cursor-pointer select-none transition-all"
                        data-id="kid">
                        <div
                            class="radio w-4 h-4 rounded-full border flex items-center justify-center transition-colors border-gray-300">
                            <div class="w-2 h-2 rounded-full bg-transparent"></div>
                        </div>
                        <span class="text-sm">小孩子</span>
                    </div>
                    <div class="age-option flex items-center gap-2 p-3 rounded-lg border cursor-pointer select-none transition-all"
                        data-id="elderly">
                        <div
                            class="radio w-4 h-4 rounded-full border flex items-center justify-center transition-colors border-gray-300">
                            <div class="w-2 h-2 rounded-full bg-transparent"></div>
                        </div>
                        <span class="text-sm">老人家</span>
                    </div>
                    <div class="age-option flex items-center gap-2 p-3 rounded-lg border cursor-pointer select-none transition-all"
                        data-id="custom">
                        <div
                            class="radio w-4 h-4 rounded-full border flex items-center justify-center transition-colors border-gray-300">
                            <div class="w-2 h-2 rounded-full bg-transparent"></div>
                        </div>
                        <div class="flex items-center gap-1">
                            <input type="number" id="custom-age-input" value="30"
                                class="w-12 px-1 py-0.5 border rounded text-center text-sm" placeholder="歲">
                            <span class="text-sm">歲</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Generation Controls -->
        <div
            class="sticky bottom-4 z-30 flex gap-3 shadow-xl rounded-xl bg-white/90 backdrop-blur p-2 border border-green-100">
            <button id="generate-btn"
                class="flex-1 bg-line hover:bg-line-dark text-white font-bold py-3 px-6 rounded-lg transition-all flex items-center justify-center gap-2 shadow-lg hover:shadow-green-200 disabled:opacity-50 disabled:cursor-not-allowed">
                <i data-lucide="wand-2" size="20"></i>
                <span id="generate-btn-text">開始生成貼圖</span>
            </button>
            <button id="stop-btn"
                class="hidden px-4 bg-red-500 hover:bg-red-600 text-white rounded-lg font-medium transition-colors">
                <i data-lucide="square" size="20"></i>
            </button>
        </div>

        <!-- 4. Results Section -->
        <section id="results-section" class="bg-white rounded-xl p-5 shadow-sm border border-gray-100 hidden">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-semibold flex items-center gap-2 text-gray-800">
                    <span
                        class="w-6 h-6 rounded-full bg-line-light text-line-dark flex items-center justify-center text-xs font-bold shadow-sm">4</span>
                    生成結果
                </h2>

                <div class="flex gap-2">
                    <button id="download-zip-btn"
                        class="hidden text-xs flex items-center gap-1 px-3 py-1.5 bg-blue-50 text-blue-600 rounded hover:bg-blue-100 font-medium transition-colors">
                        <i data-lucide="download" size="14"></i> 原圖 ZIP
                    </button>
                    <button id="remove-bg-btn"
                        class="hidden text-xs flex items-center gap-1 px-3 py-1.5 bg-purple-50 text-purple-600 rounded hover:bg-purple-100 font-medium transition-colors">
                        <i data-lucide="layers" size="14"></i> 一鍵去背
                    </button>
                    <button id="download-transparent-zip-btn"
                        class="hidden text-xs flex items-center gap-1 px-3 py-1.5 bg-yellow-50 text-yellow-700 rounded hover:bg-yellow-100 font-bold transition-colors">
                        <i data-lucide="download" size="14"></i> 去背 ZIP
                    </button>
                </div>
            </div>

            <!-- Progress Bar -->
            <div id="progress-container" class="hidden mb-4 space-y-2">
                <div class="flex justify-between text-xs text-gray-500 font-medium">
                    <span id="progress-text">準備中...</span>
                    <span><span id="progress-current">0</span>/<span id="progress-total">0</span></span>
                </div>
                <div class="w-full bg-gray-100 rounded-full h-2 overflow-hidden">
                    <div id="progress-bar" class="bg-line h-full transition-all duration-300" style="width: 0%"></div>
                </div>
            </div>

            <!-- Results Grid -->
            <div id="results-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
                <!-- Result items injected by JS -->
            </div>
        </section>

    </main>

    <!-- Scripts -->
    <script src="js/app.js" type="module"></script>
    <script>
        // Start Icons
        lucide.createIcons();
    </script>
</body>

</html>